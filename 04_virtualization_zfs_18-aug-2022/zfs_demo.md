Демо на ProxMox -> Huper-V windows

Добавим к ВМ ProxMox 4 диска по 2Гб.

### RAID10 ###
		
Создадим zpool
		
```
zpool create mypool mirror /dev/sdb /dev/sdc mirror /dev/sdd /dev/sde
```
```
zpool list
```
			
### Дата сеты ###

При создании пула файловая система автоматически создает корневой дата сет, который мы видим [zfs list] /mypool и монтирует его в корневую папку системы. В ней мы можем создавать любые файлы и директории.
			
```
mkdir /mypool/data
```
```
touch /mypool/data/file1
```
```
touch /mypool/data/file2
```
			
однако помимо этого внутри можно создавать свои датасеты

```
zfs create mypool/data
```

			
В этих дата сетах тоже можно создавать файлы. В первом приближении дата сет ведет себя как директория. Дата сет не может находиться в простой директории.
Дата сеты позволяют сделать снимки файловой системы. Мы видим дата сеты использовав команду 

```
zfs list
```
					
Выберем один из дата сетов и создадим файл.
					
```
dd if=/dev/urandom of=/mypool/data/file1 bs=1M count=500
```
					
Сделаем моментальный снимок
```
zfs snapshot mypool/data@snap1
```
					
Эта команда создает специальный дата сет только для чтения, его изменить нельзя. Он является полной копией mypool/data.
Что бы его увидеть в списке

```
zfs list -t all
```
												
При создании снимка, копирования данных не происходит, копируются только метаданные дата сета со всей информацией, какие файлы он содержит и из каких блоков эти файлы состоят.
					
Cоздадим еще один файл.

```
dd if=/dev/urandom of=/mypool/data/file2 bs=1M count=100
```
					
Давайте удалим файл *mypool/data/file1*	
				
```
rm /mypool/data/file1
```
						
```
zfs list -t all
```
						
Мы видим что снимок имеет размер удаленного файла. Снимки доступны как директории это дата сета.
						
```
ls /mypool/data/.zfs/snapshot/snap1
```

Можно скопировать удаленный файл в новое место.
Можно откатить состояние дата сета из любой версии.

```
zfs rollback mypool/data@snap2
```
					
### Атрибуты ### 
Это - определят в каком режиме будет работать файловая система
		
```
zfs get all
```
		
Некоторые нельзя менять. Они наследуются для внутренниз атрибутов, если только явным образом не переопределены.							
			
### Quota ### 

Это - органичения использования дискового пространства. Чтоб задать квоту на дата сет нужно установить атрибут.
	
```
zfs set quota=1G mypool
```
						
Ограничения относятся ко всем дата сетам в сумме. Ограничения относятся к реальному месту на диске.
Попробуем записать файл в дата сет

```
dd if=/dev/urandom of=/mypool/data/file3 bs=1M count=1000
```
					
Вывод - квота превышена
					
### Дедубликация данных ###
			
Разные пользователи растаскивают одни и теже файлы по своим папкам. Поэтому при создании нового блока данных  проверяется если он уже есть в системе. Если есть он не записывается а переиспользуется с помощью указателя. Для этого файловая система хранит хэш таблицу всех блоков и использует ее для нахождения дубликатов. 
Активируем дедубликацию.
					
```
zfs set dedup=on mypool
```
					
Создадим простой текстовый файл

`nano /mypool/test`  и копируем в файл любой текстовый, сохраняем и копируем файл несколько раз

```
cp /mypool/test /mypool/test1
```

```
cp /mypool/test /mypool/test2
```
				
```
cp /mypool/test /mypool/test3
```

```
cp /mypool/test /mypool/test4
```
						
Посмотрим на результат (колонка DEDUP)

```
zpool list mypool
```
								
### Сжатие данных ###

Улалим пул и создадим новый.
				
```
zpool destroy mypool
```

```
zpool create mypool mirror /dev/sdb /dev/sdc mirror /dev/sdd /dev/sde
```
					
Создадим датасет 

```
zfs create mypool/data
```
					
Выведем атрибуты связанные с компресией данных
					
```
get compression mypool
```
					
```
get compression mypool/data
```

Установим атрибут compression

```
zfs set compression=zstd mypool
```
						
Видим что тип алгоритма изменился на zstd.
Создатим текстовый файл
						
```
nano /mypool/deta/text
```
					
 атрибуты связанные с компресией данных
				
```
zfs get compressratio mypool
```
						
```
zfs get compressratio mypool/data
```
